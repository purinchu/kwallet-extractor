#!/usr/bin/env python

# /// script
# requires-python = ">=3.12"
# dependencies = []
# ///

from typing import Any
import argparse
import sys
import xml.etree.ElementTree as ET

# "uv tool run mypy --strict kwallet-extractor" for type checking
def main() -> None:
    # parse cmdline args
    parser = argparse.ArgumentParser(
            description='Extracts passwords and credentials from KWallet XML files'
            )
    parser.add_argument('-a', '--all-fields', action='store_true',
                        help='Extract from all KWallet folders, not just "Passwords"')
    parser.add_argument('input',
                        help='Path to XML export to read')

    args = parser.parse_args()

    try:
        root = parse_xml(args.input)

        out = dict()
        for folder in root:
            if folder.tag != 'folder':
                raise Exception(f"Encountered invalid folder tag <{folder.tag}>")

            name = folder.attrib.get('name')
            num_children = len(folder)

            print(f"Handling folder {name} with {num_children} items")

            for entry in folder:
                entry_name = entry.attrib.get('name')
                entry_type = entry.tag
                key = '/'.join([name, entry_type, entry_name])

                if len(entry) == 0:
                    value = entry.text or ''

                    if key in out and out[key] != value:
                        raise Exception(f"Value for {key} would be overwritten by a different value!")

                    out[key] = value
                else:
                    child_entries = extract_map_entries(entry, key)
                    for child_key in child_entries:
                        if child_key in out and out[child_key] != child_entries[child_key]:
                            raise Exception(f"Value for map {child_key} would be overwritten by a different value!")

                    out |= child_entries

        print(f"Done reading {len(out)} entries")

        serialize(out)

    except Exception as e:
        # Some kind of error encountered
        print(f"Ran into an error while reading {args.input}:\n{e}")
        sys.exit(1)

def extract_map_entries(map_elem: ET.Element, base_key: str) -> dict[str, str]:
    map_entries = dict()

    for child_entry in map_elem:
        if child_entry.tag != 'mapentry':
            raise Exception(f"Encountered <{child_entry.tag}> when <mapentry> expected!")

        child_entry_name = child_entry.attrib.get('name')
        child_entry_value = child_entry.text or ''

        # This can happen on old XML exports dating back to KDE 3 times, apparently. For some of my
        # Bugzilla passwords there will be a <mapentry name="">password</mapentry> with two more
        # 'normal' map entries with the actual username/password.
        if child_entry_name is None or len(child_entry_name) < 1:
            print (f"Ignoring mapentry for {base_key} with an empty name")
            continue

        # Likewise there can be empty form data values for things like address fields left blank.
        # We can just skip these without a warning
        if len(child_entry_value) < 1:
            continue

        key = '/'.join([base_key, child_entry_name])
        map_entries[key] = child_entry_value

    return map_entries

def serialize(entries: dict[str, str]) -> None:
    for name, pw in entries.items():
        print (f'{name},"{pw}"')

def parse_xml(filename: str) -> ET.Element:
    tree = ET.parse(filename)
    root = tree.getroot()

    if root.tag != "wallet":
        raise Exception(f"The wallet XML had the wrong root element! Expected <wallet>, got <{root.tag}>")

    return root

if __name__ == "__main__":
    main()
